<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhET File System Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1 {
      color: #0077cc;
    }
    #results {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 20px;
      margin: 20px 0;
      background-color: #f9f9f9;
    }
    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .file-item {
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 4px;
    }
    .file-exists {
      background-color: #e7f7e7;
      border-left: 4px solid #2ecc71;
    }
    .file-missing {
      background-color: #ffecec;
      border-left: 4px solid #e74c3c;
    }
    .status-indicator {
      display: inline-block;
      width: 20px;
      text-align: center;
      margin-right: 10px;
    }
    .controls {
      margin: 20px 0;
    }
    button {
      background-color: #0077cc;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background-color: #005fa3;
    }
    .testing {
      opacity: 0.7;
      pointer-events: none;
    }
    #status {
      margin-top: 20px;
      font-style: italic;
      color: #666;
    }
    details {
      margin: 20px 0;
    }
    summary {
      cursor: pointer;
      padding: 10px;
      background-color: #f1f1f1;
      border-radius: 4px;
    }
    summary:hover {
      background-color: #e9e9e9;
    }
    pre {
      background-color: #f8f8f8;
      padding: 15px;
      overflow-x: auto;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1>PhET File System Test</h1>
  <p>This page tests if critical PhET files are available on the server.</p>
  
  <div class="controls">
    <button id="test-all">Test All Critical Files</button>
    <button id="test-module-import">Test Module Import</button>
    <button id="test-env">Check Environment</button>
  </div>
  
  <div id="status">Ready to run tests...</div>
  <div id="results"></div>
  
  <details>
    <summary>Test Information</summary>
    <p>This diagnostic page checks for the existence of critical files needed by the PhET simulation. 
    The most common issue is files not being properly included in the Railway deployment.</p>
    
    <h3>Critical Files:</h3>
    <pre id="critical-files-list"></pre>
  </details>
  
  <script>
    // List of critical files to check
    const criticalFiles = [
      '/joist/js/preferences/PreferencesModel.js',
      '/joist/js/Sim.js',
      '/joist/js/simLauncher.js',
      '/tandem/js/Tandem.js',
      '/dot/js/dot.js',
      '/axon/js/DerivedProperty.js',
      '/scenery/js/nodes/Node.js',
      '/dot/js/util/toFixed.js',
      '/dot/js/util/solveLinearRootsReal.js',
      '/dot/js/util/sinh.js',
      '/axon/js/Property.js',
      '/dot/js/Vector2.js',
      '/kite/js/Shape.js'
    ];
    
    // Populate the critical files list
    document.getElementById('critical-files-list').textContent = criticalFiles.join('\n');
    
    // Function to check if a file exists
    async function checkFileExists(url) {
      try {
        const response = await fetch(url, { method: 'HEAD' });
        return response.ok;
      } catch (e) {
        console.error(`Error checking ${url}:`, e);
        return false;
      }
    }
    
    // Function to test module import
    async function testModuleImport() {
      const statusEl = document.getElementById('status');
      const resultsEl = document.getElementById('results');
      
      statusEl.textContent = 'Testing ES module import...';
      resultsEl.innerHTML = '<div>Attempting to import a module directly. Check console for errors.</div>';
      
      const script = document.createElement('script');
      script.type = 'module';
      script.textContent = `
        try {
          // Try to import one of the modules
          import('/dot/js/dot.js')
            .then(module => {
              document.getElementById('results').innerHTML += '<div class="file-item file-exists">✅ Module successfully imported!</div>';
              console.log('Module loaded:', module);
            })
            .catch(error => {
              document.getElementById('results').innerHTML += '<div class="file-item file-missing">❌ Module import failed: ' + error.message + '</div>';
              console.error('Module import error:', error);
            });
        } catch (e) {
          document.getElementById('results').innerHTML += '<div class="file-item file-missing">❌ Exception during import: ' + e.message + '</div>';
          console.error('Import exception:', e);
        }
      `;
      document.body.appendChild(script);
      
      statusEl.textContent = 'Module import test initiated. Check results and console for details.';
    }
    
    // Function to check environment
    async function checkEnvironment() {
      const statusEl = document.getElementById('status');
      const resultsEl = document.getElementById('results');
      
      statusEl.textContent = 'Checking server environment...';
      resultsEl.innerHTML = '<div>Fetching environment details...</div>';
      
      try {
        const response = await fetch('/env');
        const data = await response.json();
        
        let html = '<h3>Server Environment</h3>';
        html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        
        resultsEl.innerHTML = html;
        statusEl.textContent = 'Environment check complete.';
      } catch (e) {
        resultsEl.innerHTML = '<div class="file-item file-missing">❌ Error fetching environment: ' + e.message + '</div>';
        statusEl.textContent = 'Environment check failed.';
      }
    }
    
    // Function to test all critical files
    async function testAllFiles() {
      const statusEl = document.getElementById('status');
      const resultsEl = document.getElementById('results');
      const testButton = document.getElementById('test-all');
      
      // Disable button during test
      testButton.disabled = true;
      document.body.classList.add('testing');
      statusEl.textContent = 'Testing files...';
      resultsEl.innerHTML = '';
      
      let html = '<h3>File Check Results</h3><ul class="file-list">';
      
      const results = await Promise.all(criticalFiles.map(async file => {
        const exists = await checkFileExists(file);
        return { file, exists };
      }));
      
      // Also check phet-modules directory
      const phetModulesExists = await checkFileExists('/phet-modules');
      results.push({ 
        file: '/phet-modules directory', 
        exists: phetModulesExists 
      });
      
      // Check manifest file
      const manifestExists = await checkFileExists('/phet-manifest.json');
      let manifestData = null;
      if (manifestExists) {
        try {
          const response = await fetch('/phet-manifest.json');
          manifestData = await response.json();
        } catch (e) {
          console.error('Error fetching manifest:', e);
        }
      }
      results.push({ 
        file: '/phet-manifest.json', 
        exists: manifestExists 
      });
      
      // Generate HTML for results
      for (const result of results) {
        html += `<li class="file-item ${result.exists ? 'file-exists' : 'file-missing'}">
          <span class="status-indicator">${result.exists ? '✅' : '❌'}</span>
          ${result.file}
        </li>`;
      }
      
      html += '</ul>';
      
      // Add manifest data if available
      if (manifestData) {
        html += '<h3>Manifest Data</h3>';
        html += '<pre>' + JSON.stringify(manifestData, null, 2) + '</pre>';
      }
      
      resultsEl.innerHTML = html;
      statusEl.textContent = 'File check complete.';
      
      // Re-enable button
      testButton.disabled = false;
      document.body.classList.remove('testing');
    }
    
    // Attach event listeners
    document.getElementById('test-all').addEventListener('click', testAllFiles);
    document.getElementById('test-module-import').addEventListener('click', testModuleImport);
    document.getElementById('test-env').addEventListener('click', checkEnvironment);
  </script>
</body>
</html> 